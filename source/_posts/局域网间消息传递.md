---
title: 局域网间消息传递
date: 2022-10-12 19:47:59
tags:
categories:
---

局域网 IP 之间如何传递消息？

<!--more-->

假设：
- 腾讯服务器IP为118.89.97.19（当然实际会用域名，但经过DNS解析后还是IP，并且会又很多集群和部署在不同城市的机房）
- 家里的路由器拨号后有公网IP，不像校园网，分配的还是内网IP；
- 两个路由器公网IP分别为101.45.251.154、218.80.220.124；
- 登录时成功时，小明在自己电脑查看建立的TCP连接：
192.168.1.101:2099 118.89.97.19:80 establish
- 这只是一个假象，在腾讯服务器端查看到的连接是（端上IP和端口从192.168.1.101:2099变换成了路由器公网IP101.45.251.154和10000）：
118.89.97.19:80 101.45.251.154:10000 establish 
- 同理小明女朋友登录后也是同样的情况。
源IP 192.168.1.101|源端口2099|收件人、消息内容|目标IP 118.89.97.19|目标端口80

数据包到达家里路由器，源IP地址会被NAT（了解更多请自己百度）更换成101.45.251.154，端口会被换成10000，然后经过层层转发到腾讯服务器，会得到“收件人、消息内容”的数据，然后入库并根据收件人将图片的数据，服务器检测到女朋友的账号又新消息到达时，从数据库读取消息，写入小明女朋友手机跟腾讯服务器之间的长连接通道，这时数据报文格式为：

源IP 118.89.97.19|源端口80|图片消息内容|目标IP 218.80.220.124|目标端口31214（女朋友手机聊天软件跟服务器通信时创建的端口）

消息同样经过层层转发到达女朋友家里的路由器，路由器根据端口31214，查到这个是需要发到女朋友手机上的，于是NAT把目标IP换成192.168.1.101，端口换成8888，于是手机收到消息并分发给聊天软件。

参考：
- [联网的软件是如何实现将消息从公网发送到内网的？](https://www.zhihu.com/question/64560386/answer/225743007)
